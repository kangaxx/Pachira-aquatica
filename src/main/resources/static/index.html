<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期货日内分钟级K线图</title>
    <!-- 引入ECharts库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入SockJS客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <!-- 引入ECharts库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入SockJS客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <!-- 引入STOMP客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        #chart-container {
            width: 100%;
            height: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .info {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1 class="header">期货日内分钟级实时K线图</h1>
    <div class="info">数据每分钟自动更新，当前时间：<span id="current-time"></span></div>
    <div id="chart-container"></div>

    <script>
        // 初始化图表
        var chart = echarts.init(document.getElementById('chart-container'));

        // 图表配置
        var option = {
            title: {
                text: '分钟级K线图',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: [],
                axisLabel: {
                    formatter: function(value) {
                        // 格式化时间显示
                        return value.substring(11, 16); // 只显示时分
                    }
                }
            },
            yAxis: {
                type: 'value',
                scale: true
            },
            series: [
                {
                    type: 'candlestick',
                    data: [],
                    itemStyle: {
                        color: '#26a69a', // 上涨颜色（绿）
                        color0: '#ef5350', // 下跌颜色（红）
                        borderColor: '#26a69a',
                        borderColor0: '#ef5350'
                    }
                }
            ]
        };

        chart.setOption(option);

        // 存储K线数据
        var kLineData = [];
        var timeLabels = [];

        // 更新时间显示
        function updateCurrentTime() {
            var now = new Date();
            var timeStr = now.toLocaleTimeString();
            document.getElementById('current-time').textContent = timeStr;
        }

        // 每秒更新一次时间
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();

        // 连接WebSocket
        var socket = new SockJS('/ws');
        var stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);

            // 订阅K线数据主题
            stompClient.subscribe('/topic/kline', function(message) {
                var kLine = JSON.parse(message.body);
                console.log('Received KLine:', kLine);

                // 转换时间格式
                var time = new Date(kLine.time);
                var timeLabel = time.toISOString().substring(0, 19);

                // 转换K线数据格式 [open, close, low, high]
                var dataPoint = [
                    kLine.open,
                    kLine.close,
                    kLine.low,
                    kLine.high
                ];

                // 添加到数据数组
                timeLabels.push(timeLabel);
                kLineData.push(dataPoint);

                // 只保留最近100条数据
                if (kLineData.length > 100) {
                    kLineData.shift();
                    timeLabels.shift();
                }

                // 更新图表
                chart.setOption({
                    xAxis: {
                        data: timeLabels
                    },
                    series: [
                        {
                            data: kLineData
                        }
                    ]
                });
            });

            // 请求历史数据
            stompClient.send('/app/history');
        });

        // 窗口大小变化时重绘图表
        window.addEventListener('resize', function() {
            chart.resize();
        });
    </script>
</body>
</html>